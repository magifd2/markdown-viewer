### ディレクトリトラバーサル脆弱性修正の試みと失敗の経緯

**概要:**
本資料は、Markdown Viewer アプリケーションにおけるディレクトリトラバーサル脆弱性への修正試行とその失敗の経緯をまとめたものです。主な課題は、Go の `net/http` パッケージがリクエストパスを自動的に正規化・リダイレクトする挙動であり、これにより悪意のあるパスを早期に捕捉・検証することが困難でした。

**現在のコードベースの状態:**
すべての修正試行はロールバックされ、コードベースは `v0.1.0-feature-complete` タグの状態に戻っています。

---

**1. 脆弱性の初期認識と対策方針**

*   **脆弱性の内容:** アプリケーションが、指定されたルートディレクトリ (`s.Config.TargetDir`) の外部にあるファイルやディレクトリへのアクセスを許可してしまう。
*   **初期対策方針:**
    1.  リクエストされたパスを絶対パスに展開する。
    2.  その絶対パスが、アプリケーションの起動時に指定されたルートパスの配下にあるかをチェックする。
    3.  範囲外であればアクセスを拒否する (`403 Forbidden` または `404 Not Found`)。
*   **関連ファイル:**
    *   `internal/server/handlers.go`: `MarkdownViewHandler` と `ApiListHandler` がファイルパスを処理。
    *   `internal/filebrowser/filebrowser.go`: `ListDirectory` 関数がファイルパスを処理。
    *   `internal/config/config.go`: `s.Config.TargetDir` (ルートパス) の定義。

---

**2. 修正試行 1: `IsPathSafe` 関数の導入とハンドラ内での利用**

*   **試みた内容:**
    *   `internal/filebrowser/filebrowser.go` に `IsPathSafe` ヘルパー関数を導入。この関数は、与えられたパスが指定されたルートパスの配下にあるかを `filepath.Abs` と `filepath.Clean` を用いて検証する。
    *   `internal/server/handlers.go` の `MarkdownViewHandler` および `internal/filebrowser/filebrowser.go` の `ListDirectory` 関数内で、ファイルアクセスを行う直前に `IsPathSafe` を呼び出し、パスの安全性をチェックするロジックを追加。
*   **失敗の原因:**
    *   `curl -v --path-as-is http://localhost:8888/view/../go.mod` のような悪意のあるリクエストに対して、サーバーは `301 Moved Permanently` を返し、`/go.mod` へリダイレクトしてしまった。
    *   これは、Go の `net/http.ServeMux` が、ハンドラがリクエストを処理する**前**に、リクエストパスを自動的に正規化（例: `../` を解決）し、必要に応じてリダイレクトを行うため。結果として、`IsPathSafe` が呼び出される時点では、既にパスが正規化されており、脆弱な状態のパスを捕捉できなかった。

---

**3. 修正試行 2: `Server.ServeHTTP` でのカスタムルーティングと早期パス正規化**

*   **試みた内容:**
    *   `net/http.ServeMux` の自動的なパス正規化を回避するため、`internal/server/server.go` の `Server` 構造体に `ServeHTTP` メソッドを実装し、`s.httpServer.Handler` を `s` 自身に設定。
    *   `ServeHTTP` メソッド内で、`r.URL.Path` を `filepath.Clean` で正規化し、その `cleanedPath` を基に `switch` 文でルーティングロジックを直接実装。
    *   `IsPathSafe` の呼び出しは、引き続き各ハンドラ内で行う方針とした。
*   **失敗の原因:**
    *   **コンパイルエラー:** `strings` パッケージのインポート漏れや、未使用変数のエラーが発生。
    *   **正常系動作の破壊 (リグレッション):**
        *   ディレクトリリスト表示 (`/api/list?path=/`) や `treeview.html` (`/files/`) が `404 Not Found` を返すようになった。これは、`ServeHTTP` 内のルーティングロジック（特に `strings.HasPrefix` と厳密なパスマッチングの混在）に誤りがあったため。
        *   例えば、`/api/list` のようなクエリパラメータを持つパスに対して、厳密なパスマッチングを行っていたため、クエリパラメータが無視され、ハンドラが正しく機能しなかった。
    *   **脆弱性対策の不完全性:** ルーティングの問題を修正した後も、`curl -v --path-as-is http://localhost:8888/view/../go.mod` は依然として `301 Moved Permanently` を返した。これは、`ServeHTTP` でのパス正規化だけでは不十分であり、Go の `net/http` パッケージのより低レベルな部分でパスが処理されてしまうため、元の悪意のあるパスを完全に捕捉・検証できていないことを示唆している。

---

**結論と今後の課題:**

これまでの試みから、Go の `net/http` パッケージが持つ強力なパス正規化とリダイレクトの挙動が、この脆弱性修正の最大の障壁であることが判明しました。カスタムハンドラやミドルウェアがリクエストパスを信頼性高く検証するためには、`http` パッケージがパスを処理する**前**に、元の未加工のパスを確実に取得し、検証するメカニズムが必要です。

今後の課題は、この `http` パッケージの挙動を完全に理解し、それを回避または利用して、リクエストライフサイクルの最も早い段階で、かつ一元的にパスの安全性を検証する堅牢なメカニズムを実装することです。
